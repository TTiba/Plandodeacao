<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Plano de Trabalho</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- html2pdf.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <!-- Firebase SDKs (Compat for easier HTML usage) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        .a4-page {
            width: 210mm;
            min-height: 297mm;
            padding: 20mm;
            margin: auto;
            background: white;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        @media screen and (max-width: 768px) {
            .a4-page {
                width: 100%;
                padding: 1rem;
            }
        }

        /* Hide buttons during print/pdf generation if needed, though we select specific element */
        @media print {
            body * {
                visibility: hidden;
            }

            #preview-container,
            #preview-container * {
                visibility: visible;
            }

            #preview-container {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                margin: 0;
                padding: 0;
                box-shadow: none;
            }
        }
    </style>
</head>

<body class="h-screen flex flex-col overflow-hidden relative">

    <!-- Login Overlay -->
    <div id="login-overlay"
        class="fixed inset-0 bg-gray-900 bg-opacity-90 z-50 flex items-center justify-center backdrop-blur-sm transition-opacity duration-300">
        <div
            class="bg-white p-8 rounded-xl shadow-2xl max-w-md w-full border border-gray-200 text-center transform scale-100 transition-transform duration-300">
            <div class="mb-6 flex justify-center">
                <div class="h-16 w-16 bg-blue-100 rounded-full flex items-center justify-center text-blue-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                    </svg>
                </div>
            </div>
            <h2 class="text-2xl font-bold text-gray-800 mb-2">Acesso Restrito</h2>
            <p class="text-gray-500 mb-6 text-sm">Faça login com seu e-mail institucional
                <strong>@escola.pr.gov.br</strong> para acessar o Gerador.
            </p>

            <!-- Firebase Sign-In Button -->
            <button onclick="loginWithGoogle()"
                class="w-full flex items-center justify-center gap-3 bg-white text-gray-700 border border-gray-300 hover:bg-gray-50 font-medium py-3 px-4 rounded-lg shadow-sm transition-all focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 h-5"
                    alt="Google">
                <span>Entrar com Google</span>
            </button>

            <p id="login-error"
                class="hidden text-red-600 text-xs mt-4 font-medium p-2 bg-red-50 rounded border border-red-100"></p>

        </div>
    </div>

    <!-- Header -->
    <!-- Plans Dashboard Modal -->
    <div id="plans-modal"
        class="hidden fixed inset-0 bg-gray-900 bg-opacity-90 z-50 flex items-center justify-center backdrop-blur-sm transition-opacity duration-300">
        <div
            class="bg-white p-8 rounded-xl shadow-2xl max-w-2xl w-full border border-gray-200 transform scale-100 transition-transform duration-300 relative h-[80vh] flex flex-col">
            <button onclick="closePlansModal()" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>

            <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-blue-600" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                </svg>
                Meus Planos de Trabalho
            </h2>

            <div class="flex-1 overflow-y-auto pr-2 mb-6" id="plans-list-container">
                <!-- Plans will be listed here -->
                <p class="text-gray-500 text-center py-10">Nenhum plano encontrado.</p>
            </div>

            <div class="border-t pt-4 flex justify-between items-center">
                <div class="text-sm text-gray-500">
                    Logado como <strong id="modal-email-display"></strong>
                </div>
                <button onclick="createNewPlan()"
                    class="bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-2.5 rounded-lg shadow transition font-medium flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                    Criar Novo Plano
                </button>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="relative text-white shadow-md z-10 h-24 flex items-center bg-[#004e9a]"
        style="background-image: url('1.png'); background-size: cover; background-position: center;">
        <div class="absolute inset-0 bg-blue-900/10"></div>

        <div class="container mx-auto flex justify-between items-center relative z-20 px-4">
            <h1 class="text-xl font-bold flex items-center gap-2 text-white drop-shadow-md"
                style="text-shadow: 0 2px 4px rgba(0,0,0,0.5);">
                Gerador de Plano de Trabalho
            </h1>

            <!-- User Controls -->
            <div id="user-controls"
                class="hidden flex items-center gap-4 bg-white/10 backdrop-blur-md p-2 rounded-lg border border-white/20">
                <div class="flex flex-col text-right mr-2">
                    <span id="display-email" class="text-xs font-semibold text-white drop-shadow-sm"></span>
                    <span id="save-status" class="text-[10px] text-gray-200 italic">Alterações salvas</span>
                </div>
                <!-- Save Button (Manual) -->
                <button onclick="openPlansModal()"
                    class="text-xs bg-blue-500 hover:bg-blue-600 text-white px-3 py-1.5 rounded transition shadow-sm border border-blue-400 mr-2">
                    Meus Planos
                </button>
                <div class="h-6 w-px bg-white/30 mr-2"></div>

                <button onclick="saveData(true)" title="Salvar agora" class="text-white hover:text-blue-200 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
                    </svg>
                </button>
                <div class="h-6 w-px bg-white/30"></div>
                <button onclick="logout()"
                    class="text-xs bg-red-500/80 hover:bg-red-600 text-white px-3 py-1.5 rounded transition shadow-sm border border-red-400">
                    Sair
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="flex flex-1 overflow-hidden">

        <!-- Editor Column (Left) -->
        <div class="w-1/2 overflow-y-auto p-6 bg-gray-50 border-r border-gray-200">
            <!-- Form Sections -->
            <!-- ... -->
            <div class="max-w-2xl mx-auto space-y-6">

                <!-- 1. Identificação -->
                <section class="bg-white p-5 rounded-lg shadow-sm border border-gray-100">
                    <h2 class="text-lg font-semibold text-gray-800 mb-4 border-b pb-2">1. Identificação</h2>
                    <div class="grid grid-cols-1 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Título do Projeto</label>
                            <input type="text" id="input-titulo"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 border"
                                placeholder="Ex: Revitalização da Biblioteca">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Embaixador Responsável</label>
                                <input type="text" id="input-responsavel"
                                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 border">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">NRE</label>
                                <select id="input-nre"
                                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 border">
                                    <option value="">Selecione...</option>
                                    <option>Apucarana</option>
                                    <option>Área Norte</option>
                                    <option>Área Sul</option>
                                    <option>Assis Chateaubriand</option>
                                    <option>Campo Mourão</option>
                                    <option>Cascavel</option>
                                    <option>Cianorte</option>
                                    <option>Cornélio Procópio</option>
                                    <option>Curitiba</option>
                                    <option>Dois Vizinhos</option>
                                    <option>F. Beltrão</option>
                                    <option>Foz do Iguaçu</option>
                                    <option>Goioerê</option>
                                    <option>Guarapuava</option>
                                    <option>Ibaiti</option>
                                    <option>Irati</option>
                                    <option>Ivaiporã</option>
                                    <option>Jacarezinho</option>
                                    <option>Laranjeiras do Sul</option>
                                    <option>Loanda</option>
                                    <option>Londrina</option>
                                    <option>Maringá</option>
                                    <option>Paranaguá</option>
                                    <option>Paranavaí</option>
                                    <option>Pato Branco</option>
                                    <option>Pitanga</option>
                                    <option>Ponta Grossa</option>
                                    <option>Telêmaco</option>
                                    <option>Toledo</option>
                                    <option>Umuarama</option>
                                    <option>União da Vitória</option>
                                    <option>Wenceslau</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Período de Execução</label>
                            <div class="flex gap-2 items-center mt-1">
                                <input type="date" id="input-periodo-inicio"
                                    class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 border">
                                <span class="text-gray-500">até</span>
                                <input type="date" id="input-periodo-fim"
                                    class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 border">
                            </div>
                        </div>
                    </div>
                </section>

                <!-- 2. Justificativa -->
                <section class="bg-white p-5 rounded-lg shadow-sm border border-gray-100">
                    <h2 class="text-lg font-semibold text-gray-800 mb-4 border-b pb-2">2. Justificativa</h2>
                    <textarea id="input-justificativa" rows="4"
                        class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 border"
                        placeholder="Descreva o contexto de ação do projeto, o que ele quer alterar, e por que isso é importante."></textarea>
                </section>

                <!-- 3. Objetivos -->
                <section class="bg-white p-5 rounded-lg shadow-sm border border-gray-100">
                    <h2 class="text-lg font-semibold text-gray-800 mb-4 border-b pb-2">3. Objetivos</h2>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700">Objetivo Geral</label>
                        <textarea id="input-objetivo-geral" rows="2"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 border"
                            placeholder="Qual é o objetivo geral desse projeto."></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Objetivos Específicos</label>
                        <div id="container-objetivos-especificos" class="space-y-2 mt-1">
                            <input type="text"
                                class="obj-esp-input block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 border"
                                placeholder="Objetivo específico">
                        </div>
                        <button type="button" onclick="addObjEspecifico()"
                            class="mt-2 text-sm text-indigo-600 hover:text-indigo-800 font-medium flex items-center gap-1">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 4v16m8-8H4" />
                            </svg>
                            Adicionar Objetivo
                        </button>
                    </div>
                </section>

                <!-- 4. Atividades a Desenvolver -->
                <section class="bg-white p-5 rounded-lg shadow-sm border border-gray-100">
                    <h2 class="text-lg font-semibold text-gray-800 mb-4 border-b pb-2">4. Atividades a Desenvolver</h2>
                    <textarea id="input-atividades" rows="4"
                        class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 border"
                        placeholder="Descreva de modo geral qual é a atividade que você pretende desenvolver."></textarea>
                </section>

                <!-- 5. Metodologia -->
                <section class="bg-white p-5 rounded-lg shadow-sm border border-gray-100">
                    <h2 class="text-lg font-semibold text-gray-800 mb-4 border-b pb-2">5. Metodologia</h2>
                    <textarea id="input-metodologia" rows="4"
                        class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 border"
                        placeholder="Explique como as atividades serão executadas..."></textarea>
                </section>

                <!-- 6. Cronograma -->
                <section class="bg-white p-5 rounded-lg shadow-sm border border-gray-100">
                    <h2 class="text-lg font-semibold text-gray-800 mb-4 border-b pb-2">6. Cronograma</h2>
                    <div id="container-cronograma" class="space-y-4">
                        <!-- Dynamic cronograma items will appear here -->
                    </div>
                    <button type="button" onclick="addCronogramaItem()"
                        class="mt-4 text-sm text-indigo-600 hover:text-indigo-800 font-medium flex items-center gap-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                        </svg>
                        Adicionar Atividade
                    </button>
                </section>

                <!-- 7. Recursos Necessários -->
                <section class="bg-white p-5 rounded-lg shadow-sm border border-gray-100">
                    <h2 class="text-lg font-semibold text-gray-800 mb-4 border-b pb-2">7. Recursos Necessários</h2>
                    <textarea id="input-recursos" rows="4"
                        class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 border"
                        placeholder="Descreva os recursos humanos, materiais e financeiros necessários..."></textarea>
                </section>

                <!-- 8. Resultados Esperados -->
                <section class="bg-white p-5 rounded-lg shadow-sm border border-gray-100">
                    <h2 class="text-lg font-semibold text-gray-800 mb-4 border-b pb-2">8. Resultados Esperados</h2>
                    <textarea id="input-resultados" rows="4"
                        class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 border"
                        placeholder="Descreva os resultados e benefícios esperados..."></textarea>
                </section>

                <!-- 9. Avaliação e Acompanhamento -->
                <section class="bg-white p-5 rounded-lg shadow-sm border border-gray-100">
                    <h2 class="text-lg font-semibold text-gray-800 mb-4 border-b pb-2">9. Avaliação e Acompanhamento
                    </h2>
                    <textarea id="input-avaliacao" rows="4"
                        class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 border"
                        placeholder="Liste aqui quais são os itens a serem acompanhados para verificar o sucesso da ação, por exemplo, números de atribuição, questões respondidas, etc"></textarea>
                </section>

                <!-- 10. Assinaturas -->
                <section class="bg-white p-5 rounded-lg shadow-sm border border-gray-100 mb-10">
                    <h2 class="text-lg font-semibold text-gray-800 mb-4 border-b pb-2">10. Assinaturas</h2>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Nome Responsável</label>
                            <input type="text" id="input-sig-resp"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 border">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Nome Supervisor</label>
                            <input type="text" id="input-sig-sup"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 border">
                        </div>
                    </div>
                </section>

            </div>
        </div>

        <!-- Preview Column (Right) -->
        <div class="w-1/2 overflow-y-auto bg-gray-200 p-8 flex justify-center">
            <!-- Container for pages -->
            <div id="print-area" class="flex flex-col gap-8 w-[210mm] print:gap-0">
                <!-- Pages will be injected here by JS -->
                <div class="a4-page bg-white shadow-lg p-[20mm] min-h-[297mm] relative">
                    <!-- Initial Placeholder -->
                    <p class="text-gray-400 text-center mt-20">O documento aparecerá aqui...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-white border-t border-gray-200 p-4 flex justify-end items-center gap-4 shadow-inner z-20">

        <button onclick="generatePDF()"
            class="bg-[#00A340] hover:bg-[#008f38] text-white px-6 py-2 rounded shadow transition text-sm font-medium flex items-center gap-2 border border-[#008f38]">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
            </svg>
            Baixar PDF
        </button>
    </footer>

    <script>
        // Global User State
        let currentUser = null;
        let currentPlanId = null;

        // ---------------------------------------------------------
        // Firebase Configuration & Initialization
        // ---------------------------------------------------------

        // SUBSTITUA COM SUAS CHAVES DO FIREBASE AQUI
        // Você pode obter isso no Console do Firebase > Configurações do Projeto > Geral > Seus aplicativos
        const firebaseConfig = {
            apiKey: "AIzaSyDJMxrPMG0lA44FbwtPDIWrxmGLUrJdZ4Y",
            authDomain: "geradorplanotrabalho.firebaseapp.com",
            projectId: "geradorplanotrabalho",
            storageBucket: "geradorplanotrabalho.firebasestorage.app",
            messagingSenderId: "697029999776",
            appId: "1:697029999776:web:953bdee8dd335d91469dc5"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // ---------------------------------------------------------
        // Authentication Logic
        // ---------------------------------------------------------

        function loginWithGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            // Optional: force account selection
            provider.setCustomParameters({ prompt: 'select_account' });

            auth.signInWithPopup(provider)
                .then((result) => {
                    // User logged in!
                    // updateUIForLogin handled by onAuthStateChanged
                })
                .catch((error) => {
                    console.error("Login Error:", error);
                    const errDiv = document.getElementById('login-error');
                    errDiv.innerText = "Erro no login: " + error.message;
                    errDiv.classList.remove('hidden');
                });
        }

        function logout() {
            auth.signOut().then(() => {
                location.reload();
            });
        }

        // Listen for auth state changes
        auth.onAuthStateChanged((user) => {
            if (user) {
                // Check email domain restrictions if necessary
                // const email = user.email;
                // if (!email.endsWith('@escola.pr.gov.br')) { ... }

                currentUser = {
                    email: user.email,
                    name: user.displayName,
                    picture: user.photoURL,
                    uid: user.uid
                };
                updateUIForLogin();
                loadPlansIndex(); // Refresh list from Firestore
            } else {
                currentUser = null;
                // Show login overlay if not already shown? 
                // The overlay is default visible, unhidden by reload
            }
        });

        function updateUIForLogin() {
            if (!currentUser) return;

            // Hide overlay
            document.getElementById('login-overlay').classList.add('opacity-0', 'pointer-events-none');
            setTimeout(() => {
                document.getElementById('login-overlay').classList.add('hidden');
            }, 300);

            // Show user controls
            document.getElementById('user-controls').classList.remove('hidden');
            document.getElementById('user-controls').classList.add('flex');

            // Set user email/name
            document.getElementById('display-email').innerText = currentUser.email;
            document.getElementById('modal-email-display').innerText = currentUser.email;
        }

        function checkSession() {
            // Firebase handles this automatically via onAuthStateChanged
        }

        // ---------------------------------------------------------
        // Plan Management with Firestore
        // ---------------------------------------------------------

        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // --- Plans Index (Now just querying the collection) ---

        async function loadPlansIndex() {
            if (!currentUser) return;

            try {
                const snapshot = await db.collection('users')
                    .doc(currentUser.uid)
                    .collection('plans')
                    .orderBy('updatedAt', 'desc')
                    .get();

                const plans = [];
                snapshot.forEach(doc => {
                    plans.push(doc.data());
                });

                // If no plans, initiate blank state
                if (plans.length === 0) {
                    createNewPlan(true); // Create local blank
                } else if (!currentPlanId) {
                    // Load most recent
                    loadPlan(plans[0].id);
                }
            } catch (e) {
                console.error("Error loading index:", e);
                // Fallback or alert
                if (firebaseConfig.apiKey === "YOUR_API_KEY") {
                    alert("Atenção: Configure as chaves do Firebase no arquivo index.html para funcionar!");
                }
            }
        }

        // --- UI Modal ---

        function openPlansModal() {
            if (!currentUser) return;
            renderPlansList();
            document.getElementById('plans-modal').classList.remove('hidden');
        }

        function closePlansModal() {
            document.getElementById('plans-modal').classList.add('hidden');
        }

        async function renderPlansList() {
            const container = document.getElementById('plans-list-container');
            container.innerHTML = '<p class="text-center text-gray-400">Carregando...</p>';

            if (!currentUser) return;

            try {
                const snapshot = await db.collection('users')
                    .doc(currentUser.uid)
                    .collection('plans')
                    .orderBy('updatedAt', 'desc')
                    .get();

                const plans = [];
                snapshot.forEach(doc => {
                    plans.push(doc.data());
                });

                if (plans.length === 0) {
                    container.innerHTML = '<div class="text-center py-10 flex flex-col items-center"><p class="text-gray-500">Nenhum plano encontrado.</p></div>';
                } else {
                    container.innerHTML = plans.map(plan => `
                        <div class="flex items-center justify-between p-4 bg-gray-50 hover:bg-blue-50 border border-gray-200 rounded-lg mb-3 transition-colors ${plan.id === currentPlanId ? 'border-blue-400 bg-blue-50 ring-1 ring-blue-300' : ''}">
                            <div class="cursor-pointer flex-1" onclick="loadPlan('${plan.id}'); closePlansModal();">
                                <h3 class="font-bold text-gray-800 ${!plan.title ? 'italic text-gray-500' : ''}">${plan.title || '(Sem Título)'}</h3>
                                <p class="text-xs text-gray-500">Última edição: ${plan.updatedAt ? new Date(plan.updatedAt).toLocaleString('pt-BR') : 'N/A'}</p>
                            </div>
                            <div class="flex items-center gap-2">
                                <button onclick="deletePlan('${plan.id}')" class="text-red-500 hover:bg-red-100 p-2 rounded-full" title="Excluir">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (e) {
                container.innerHTML = '<p class="text-center text-red-400">Erro ao carregar planos.</p>';
            }
        }

        function createNewPlan(skipModalClose = false) {
            // Clear inputs
            document.querySelectorAll('input, textarea, select').forEach(el => el.value = '');
            document.getElementById('container-cronograma').innerHTML = '';
            document.getElementById('container-objetivos-especificos').innerHTML = '';

            // Add defaults
            addCronogramaItem();
            addObjEspecifico(true); // helper to add blank one

            // Generate new ID
            currentPlanId = generateUUID();
            renderDocument();

            if (!skipModalClose) closePlansModal();
        }

        async function deletePlan(id) {
            if (!confirm('Tem certeza que deseja excluir este plano?')) return;
            if (!currentUser) return;

            try {
                await db.collection('users').doc(currentUser.uid).collection('plans').doc(id).delete();
                renderPlansList(); // Refresh list

                if (id === currentPlanId) {
                    createNewPlan(true);
                }
            } catch (e) {
                console.error("Error deleting", e);
                alert("Erro ao excluir.");
            }
        }

        async function loadPlan(id) {
            if (!currentUser) return;

            // Show loading indicator? 
            console.log("Loading plan...", id);

            try {
                const doc = await db.collection('users').doc(currentUser.uid).collection('plans').doc(id).get();
                if (!doc.exists) {
                    console.error("Plan not found");
                    return;
                }
                const data = doc.data();
                currentPlanId = id;

                // Populate Static
                if (data.inputs) {
                    Object.keys(data.inputs).forEach(key => {
                        const el = document.getElementById(key);
                        if (el) el.value = data.inputs[key];
                    });
                }

                // Populate Objectives
                const objContainer = document.getElementById('container-objetivos-especificos');
                objContainer.innerHTML = '';
                if (data.objetivosEspecificos && data.objetivosEspecificos.length > 0) {
                    data.objetivosEspecificos.forEach(val => {
                        createObjInput(val);
                    });
                } else {
                    createObjInput('');
                }

                // Populate Cronograma
                const cronoContainer = document.getElementById('container-cronograma');
                cronoContainer.innerHTML = '';
                if (data.cronograma && data.cronograma.length > 0) {
                    data.cronograma.forEach(item => {
                        createCronogramaInput(item);
                    });
                } else {
                    // addCronogramaItem called by createCronogramaInput not needed, separate logic
                    addCronogramaItem();
                }

                closePlansModal();
                renderDocument();

            } catch (e) {
                console.error("Error loading plan", e);
            }
        }

        // Helpers for UI creation to avoid duplication
        function createObjInput(value) {
            const container = document.getElementById('container-objetivos-especificos');
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'obj-esp-input block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 border mt-2';
            input.value = value || '';
            input.placeholder = 'Objetivo específico';
            container.appendChild(input);

            // Re-attach listeners is tricky because they are local in original code
            // We need global listener delegation or re-attach
            // Simplified: just call attach listeners helper
            attachListeners(input);
        }

        function createCronogramaInput(item) {
            // Re-use addCronogramaItem logic but populate values? 
            // Ideally refactor addCronogramaItem to accept data.
            // Implemented inline to be safe.
            const container = document.getElementById('container-cronograma');
            const div = document.createElement('div');
            div.className = 'flex flex-col gap-2 border p-3 rounded-lg bg-gray-50';
            div.innerHTML = `
                <div class="flex flex-col">
                    <label class="text-xs text-gray-500 font-medium">Data de início da atividade</label>
                    <input type="date" value="${item.date || ''}" class="crono-date block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 border">
                </div>
                <div class="flex flex-col">
                    <label class="text-xs text-gray-500 font-medium">Atividade</label>
                    <input type="text" value="${item.activity || ''}" class="crono-activity block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 border" placeholder="Descrição da atividade">
                </div>
                <div class="flex gap-2">
                    <div class="w-1/2 flex flex-col">
                        <label class="text-xs text-gray-500 font-medium">Responsável</label>
                        <input type="text" value="${item.resp || ''}" class="crono-resp block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 border" placeholder="Nome">
                    </div>
                    <div class="w-1/2 flex flex-col">
                        <label class="text-xs text-gray-500 font-medium">Local</label>
                        <input type="text" value="${item.local || ''}" class="crono-local block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 border" placeholder="Local">
                    </div>
                </div>
                <div class="flex gap-2">
                    <div class="w-1/3 flex flex-col">
                        <label class="text-xs text-gray-500 font-medium">Rec. Humanos</label>
                        <input type="text" value="${item.recHum || ''}" class="crono-rec-hum block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 border" placeholder="R. Humanos">
                    </div>
                    <div class="w-1/3 flex flex-col">
                        <label class="text-xs text-gray-500 font-medium">Rec. Materiais</label>
                        <input type="text" value="${item.recMat || ''}" class="crono-rec-mat block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 border" placeholder="R. Materiais">
                    </div>
                    <div class="w-1/3 flex flex-col">
                        <label class="text-xs text-gray-500 font-medium">Rec. Financeiros</label>
                        <input type="text" value="${item.recFin || ''}" class="crono-rec-fin block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 border" placeholder="R. Financeiros">
                    </div>
                </div>
            `;
            container.appendChild(div);
            // Attach listeners
            div.querySelectorAll('input').forEach(attachListeners);
        }

        function attachListeners(el) {
            const render = debounce(renderDocument, 500);
            const autoSave = debounce(() => saveData(false), 1000);
            el.addEventListener('input', render);
            el.addEventListener('input', autoSave);
        }

        async function saveData(manual = false) {
            if (!currentUser) return;
            if (!currentPlanId) currentPlanId = generateUUID();

            try {
                const title = document.getElementById('input-titulo').value;

                const data = {
                    id: currentPlanId,
                    updatedAt: new Date().toISOString(),
                    title: title,
                    inputs: {},
                    objetivosEspecificos: [],
                    cronograma: []
                };

                // 1. Static Inputs
                const idsToSave = [
                    'input-titulo', 'input-responsavel', 'input-nre',
                    'input-periodo-inicio', 'input-periodo-fim',
                    'input-justificativa', 'input-objetivo-geral',
                    'input-atividades', 'input-metodologia',
                    'input-recursos', 'input-resultados', 'input-avaliacao',
                    'input-sig-resp', 'input-sig-sup'
                ];

                idsToSave.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) data.inputs[id] = el.value;
                });

                // 2. Dynamic: Objetivos Específicos
                const objInputs = document.querySelectorAll('.obj-esp-input');
                data.objetivosEspecificos = Array.from(objInputs).map(i => i.value).filter(v => v);

                // 3. Dynamic: Cronograma
                const cronoItems = document.querySelectorAll('#container-cronograma > div');
                data.cronograma = Array.from(cronoItems).map(item => ({
                    date: item.querySelector('.crono-date').value,
                    activity: item.querySelector('.crono-activity').value,
                    resp: item.querySelector('.crono-resp').value,
                    local: item.querySelector('.crono-local').value,
                    recHum: item.querySelector('.crono-rec-hum').value,
                    recMat: item.querySelector('.crono-rec-mat').value,
                    recFin: item.querySelector('.crono-rec-fin').value,
                }));

                // Save to Firestore
                await db.collection('users')
                    .doc(currentUser.uid)
                    .collection('plans')
                    .doc(currentPlanId)
                    .set(data);

                // Update UI status
                const statusEl = document.getElementById('save-status');
                if (statusEl) {
                    statusEl.innerText = manual ? 'Salvo agora!' : 'Salvo auto.';
                    statusEl.classList.remove('text-gray-200');
                    statusEl.classList.add('text-green-300');
                    setTimeout(() => {
                        statusEl.innerText = 'Alterações salvas';
                        statusEl.classList.add('text-gray-200');
                        statusEl.classList.remove('text-green-300');
                    }, 2000);
                }
            } catch (e) {
                console.error("Error saving data:", e);
                const statusEl = document.getElementById('save-status');
                if (statusEl) {
                    statusEl.innerText = 'Erro ao salvar!';
                    statusEl.classList.remove('text-gray-200', 'text-green-300');
                    statusEl.classList.add('text-red-400');
                }

                if (e.code === 'permission-denied') {
                    alert("Erro de permissão! Verifique as regras do Firestore.");
                }
            }
        }

        // Debounce function to limit render calls
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Initialize Listeners
        document.addEventListener('DOMContentLoaded', () => {
            const render = debounce(renderDocument, 500);
            const autoSave = debounce(() => saveData(false), 1000); // Auto-save after 1s

            // Ensure we save before leaving
            window.addEventListener('beforeunload', () => {
                saveData(false);
            });

            // Inputs
            // We need a way to attach listeners to all existing and future inputs
            // Delegation or just attaching to existing now
            const allInputs = document.querySelectorAll('input, textarea, select');
            allInputs.forEach(el => {
                el.addEventListener('input', render);
                el.addEventListener('input', autoSave);
            });

            // Check Session
            checkSession();

            // Initial render
            setTimeout(renderDocument, 100);

            // Ensure proper initialization of dynamic lists if empty
            if (document.getElementById('container-cronograma').children.length === 0) {
                // Only if not loaded by checkoutSession -> loadData
                // With multi-plan, checkSession usually loads a plan. 
                // If not logged in, we want empty form.
                if (!currentUser) addCronogramaItem();
            }
        });

        // ---------------------------------------------------------
        // Dynamic Field Logic (Global Functions called by onclick)
        // ---------------------------------------------------------

        function addObjEspecifico() {
            const container = document.getElementById('container-objetivos-especificos');
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'obj-esp-input block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 border mt-2';
            input.placeholder = 'Outro objetivo específico';
            container.appendChild(input);

            // Attach listener to new input
            const render = debounce(renderDocument, 500);
            const autoSave = debounce(() => saveData(false), 2000);

            input.addEventListener('input', render);
            input.addEventListener('input', autoSave);

            // Render immediately
            renderDocument();
            input.focus();
        }

        function addCronogramaItem() {
            const container = document.getElementById('container-cronograma');
            const div = document.createElement('div');
            div.className = 'flex flex-col gap-2 border p-3 rounded-lg bg-gray-50';

            div.innerHTML = `
                <div class="flex flex-col">
                    <label class="text-xs text-gray-500 font-medium">Data de início da atividade</label>
                    <input type="date" class="crono-date block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 border">
                </div>
                <div class="flex flex-col">
                    <label class="text-xs text-gray-500 font-medium">Atividade</label>
                    <input type="text" class="crono-activity block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 border" placeholder="Descrição da atividade">
                </div>
                <div class="flex gap-2">
                    <div class="w-1/2 flex flex-col">
                        <label class="text-xs text-gray-500 font-medium">Responsável</label>
                        <input type="text" class="crono-resp block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 border" placeholder="Nome">
                    </div>
                    <div class="w-1/2 flex flex-col">
                        <label class="text-xs text-gray-500 font-medium">Local</label>
                        <input type="text" class="crono-local block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 border" placeholder="Local">
                    </div>
                </div>
                <div class="flex gap-2">
                    <div class="w-1/3 flex flex-col">
                        <label class="text-xs text-gray-500 font-medium">Rec. Humanos</label>
                        <input type="text" class="crono-rec-hum block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 border" placeholder="R. Humanos">
                    </div>
                    <div class="w-1/3 flex flex-col">
                        <label class="text-xs text-gray-500 font-medium">Rec. Materiais</label>
                        <input type="text" class="crono-rec-mat block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 border" placeholder="R. Materiais">
                    </div>
                    <div class="w-1/3 flex flex-col">
                        <label class="text-xs text-gray-500 font-medium">Rec. Financeiros</label>
                        <input type="text" class="crono-rec-fin block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 border" placeholder="R. Financeiros">
                    </div>
                </div>
            `;

            container.appendChild(div);

            // Attach listeners to new inputs
            const inputs = div.querySelectorAll('input');
            const render = debounce(renderDocument, 500);
            const autoSave = debounce(() => saveData(false), 2000);

            inputs.forEach(inp => {
                inp.addEventListener('input', render);
                inp.addEventListener('input', autoSave);
            });

            // Render immediately
            renderDocument();
        }


        // ---------------------------------------------------------
        // Main Render Function
        // ---------------------------------------------------------
        function renderDocument() {
            const printArea = document.getElementById('print-area');
            if (!printArea) return;
            printArea.innerHTML = ''; // Clear current pages

            // Collection of content blocks to be rendered
            const blocks = collectContentBlocks();

            let pageCount = 0;
            const createPage = () => {
                pageCount++;
                const p = createNewPage();
                // Add unique class for page break to all except first
                if (pageCount > 1) {
                    p.classList.add('page-break-before-class');
                }
                return p;
            };

            let currentPage = createPage();
            printArea.appendChild(currentPage);

            // Helper to get max content height
            const getMaxHeight = (page) => {
                const style = window.getComputedStyle(page);
                const h = page.clientHeight; // Total height including padding
                const pt = parseFloat(style.paddingTop);
                const pb = parseFloat(style.paddingBottom);
                return h - pt - pb;
            };

            // Append blocks
            blocks.forEach(block => {
                // Real implementation:
                // 1. Append HTML to a wrapper div
                const contentWrapper = document.createElement('div');
                contentWrapper.innerHTML = block;
                const element = contentWrapper.firstElementChild;

                if (!element) return;

                currentPage.appendChild(element);

                // Check if we exceeded page height
                // We use scrollHeight vs valid A4 height (297mm approx 1123px @ 96dpi)
                // A safer check is to see if the element's bottom is way down.

                const pageRect = currentPage.getBoundingClientRect();
                const elemRect = element.getBoundingClientRect();

                // Max height logic: 297mm - 40mm padding = 257mm content.
                // 257mm * 3.78 ~= 971px.
                // Let's perform a check.
                const pageStyle = window.getComputedStyle(currentPage);
                const paddingBottom = parseFloat(pageStyle.paddingBottom);
                const bottomLimit = pageRect.bottom - paddingBottom;

                // Tolerance 5px
                if (elemRect.bottom > bottomLimit + 5) {
                    // Overflow detected!
                    // Remove element from this page
                    currentPage.removeChild(element);

                    // Create new page
                    currentPage = createPage();
                    printArea.appendChild(currentPage);

                    // Add element to new page
                    currentPage.appendChild(element);
                }
            });
        }

        function createNewPage() {
            const page = document.createElement('div');
            page.className = 'a4-page bg-white shadow-lg p-[20mm] min-h-[297mm] text-black relative flex flex-col';
            return page;
        }

        function collectContentBlocks() {
            // Helper to get value
            const getVal = (id) => {
                const el = document.getElementById(id);
                return el ? el.value : '';
            };

            const blocks = [];

            // 1. Header (Banner)
            blocks.push(`
                <div class="relative mb-8 text-center h-40 overflow-hidden rounded-lg shadow-sm border border-gray-200 shrink-0">
                    <img src="document_header.png" alt="Banner" class="w-full h-full object-cover object-center">
                </div>
            `);

            // 2. Identificação
            const titulo = getVal('input-titulo');
            const resp = getVal('input-responsavel');
            const nre = getVal('input-nre');
            const start = getVal('input-periodo-inicio');
            const end = getVal('input-periodo-fim');
            const dateStr = (start || end) ? `${start ? new Date(start + 'T00:00:00').toLocaleDateString('pt-BR') : '...'} a ${end ? new Date(end + 'T00:00:00').toLocaleDateString('pt-BR') : '...'}` : '';

            blocks.push(`
                <div class="mb-6">
                    <h3 class="font-bold text-lg uppercase border-b border-gray-400 mb-2">1. Identificação</h3>
                    <table class="w-full text-sm border-collapse">
                        <tr><td class="font-bold py-1 w-48">Título do Projeto:</td><td class="py-1 border-b border-dotted border-gray-400">${titulo}</td></tr>
                        <tr><td class="font-bold py-1">Embaixador Responsável:</td><td class="py-1 border-b border-dotted border-gray-400">${resp}</td></tr>
                        <tr><td class="font-bold py-1">NRE:</td><td class="py-1 border-b border-dotted border-gray-400">${nre}</td></tr>
                        <tr><td class="font-bold py-1">Período:</td><td class="py-1 border-b border-dotted border-gray-400">${dateStr}</td></tr>
                    </table>
                </div>
            `);

            // 3. Justificativa
            blocks.push(createSectionBlock('2. Justificativa', getVal('input-justificativa')));

            // 4. Objetivos
            const objGeral = getVal('input-objetivo-geral');
            const objInputs = document.querySelectorAll('.obj-esp-input');
            let objItems = '';
            objInputs.forEach(inp => {
                if (inp.value.trim()) objItems += `<li>${inp.value}</li>`;
            });

            let objContent = `
                <div class="mb-2">
                    <span class="font-bold text-sm block">Objetivo Geral:</span>
                    <p class="text-sm text-justify whitespace-pre-wrap">${objGeral}</p>
                </div>
            `;

            if (objItems) {
                objContent += `
                     <div class="mb-2">
                        <span class="font-bold text-sm block">Objetivos Específicos:</span>
                        <ul class="list-disc list-inside text-sm pl-2">${objItems}</ul>
                     </div>
                `;
            }

            blocks.push(`
                <div class="mb-6">
                    <h3 class="font-bold text-lg uppercase border-b border-gray-400 mb-2">3. Objetivos</h3>
                    ${objContent}
                </div>
            `);

            // 5. Atividades
            blocks.push(createSectionBlock('4. Atividades a Desenvolver', getVal('input-atividades')));

            // 6. Metodologia
            blocks.push(createSectionBlock('5. Metodologia', getVal('input-metodologia')));

            // 7. Cronograma
            blocks.push(`<div class="mb-4"><h3 class="font-bold text-lg uppercase border-b border-gray-400 mb-2">6. Cronograma</h3></div>`);

            const cronoItems = document.getElementById('container-cronograma').querySelectorAll('#container-cronograma > div');
            cronoItems.forEach(item => {
                const dateVal = item.querySelector('.crono-date').value;
                const activityVal = item.querySelector('.crono-activity').value;
                const respVal = item.querySelector('.crono-resp').value;
                const localVal = item.querySelector('.crono-local').value;
                const recHumVal = item.querySelector('.crono-rec-hum').value;
                const recMatVal = item.querySelector('.crono-rec-mat').value;
                const recFinVal = item.querySelector('.crono-rec-fin').value;

                if (dateVal || activityVal || respVal || localVal) {
                    const dateFormatted = dateVal ? new Date(dateVal + 'T00:00:00').toLocaleDateString('pt-BR') : '';
                    blocks.push(`
                        <div class="border border-gray-800 rounded p-3 text-sm shadow-sm bg-white mb-4 break-inside-avoid">
                             <div class="border-b border-gray-200 pb-1">
                                <span class="font-bold text-gray-800 text-xs uppercase block">Data de início</span>
                                <span class="text-black font-semibold">${dateFormatted}</span>
                            </div>
                            <div class="border-b border-gray-200 pb-2 mt-2">
                                <span class="font-bold text-gray-800 text-xs uppercase block">Atividade</span>
                                <span class="text-black block mt-1">${activityVal}</span>
                            </div>
                            <div class="flex flex-col sm:flex-row gap-4 border-b border-gray-200 pb-2 mt-2">
                                <div class="flex-1">
                                    <span class="font-bold text-gray-800 text-xs uppercase block">Responsável</span>
                                    <span class="text-black text-sm">${respVal}</span>
                                </div>
                                <div class="flex-1">
                                    <span class="font-bold text-gray-800 text-xs uppercase block">Local</span>
                                    <span class="text-black text-sm">${localVal}</span>
                                </div>
                            </div>
                            <div class="bg-gray-50 p-2 rounded border border-gray-200 mt-2">
                                <div class="grid grid-cols-3 gap-2 text-xs">
                                    <div><span class="font-bold text-gray-600 block mb-1">R. Humanos</span><div class="text-black min-h-[1rem] break-words">${recHumVal}</div></div>
                                    <div class="border-l border-gray-300 pl-2"><span class="font-bold text-gray-600 block mb-1">R. Materiais</span><div class="text-black min-h-[1rem] break-words">${recMatVal}</div></div>
                                    <div class="border-l border-gray-300 pl-2"><span class="font-bold text-gray-600 block mb-1">R. Financeiros</span><div class="text-black min-h-[1rem] break-words">${recFinVal}</div></div>
                                </div>
                            </div>
                        </div>
                    `);
                }
            });

            // 8. Recursos
            blocks.push(createSectionBlock('7. Recursos Necessários', getVal('input-recursos')));

            // 9. Resultados
            blocks.push(createSectionBlock('8. Resultados Esperados', getVal('input-resultados')));

            // 10. Avaliação
            blocks.push(createSectionBlock('9. Avaliação e Acompanhamento', getVal('input-avaliacao')));

            // 11. Assinaturas
            const sigResp = getVal('input-sig-resp');
            const sigSup = getVal('input-sig-sup');
            blocks.push(`
                <div class="mt-8 pt-8">
                    <h3 class="font-bold text-lg uppercase border-b border-gray-400 mb-8">10. Assinaturas</h3>
                    <div class="flex justify-between mt-12 px-4 gap-8">
                        <div class="flex-1 text-center">
                            <div class="border-t border-black w-full mb-2"></div>
                            <p class="font-bold text-sm">${sigResp}</p>
                            <p class="text-xs text-gray-600">Responsável pelo plano</p>
                        </div>
                        <div class="flex-1 text-center">
                            <div class="border-t border-black w-full mb-2"></div>
                            <p class="font-bold text-sm">${sigSup}</p>
                            <p class="text-xs text-gray-600">Supervisor/Orientador</p>
                        </div>
                    </div>
                     <div class="mt-8 text-right text-sm">Data: ____/____/________</div>
                </div>
            `);

            return blocks;
        }

        function createSectionBlock(title, content) {
            return `
                <div class="mb-6">
                    <h3 class="font-bold text-lg uppercase border-b border-gray-400 mb-2">${title}</h3>
                    <p class="text-sm text-justify whitespace-pre-wrap">${content}</p>
                </div>
            `;
        }

        function generatePDF() {
            const element = document.getElementById('print-area');
            const pages = element.querySelectorAll('.a4-page');

            // Store properties to restore later
            const originalClasses = element.className;
            const originalPageStyles = [];

            // 1. Remove gap from container
            element.classList.remove('gap-8');
            element.classList.add('gap-0');

            // 2. Adjust pages to strictly fit A4 without spillover
            pages.forEach(page => {
                originalPageStyles.push({
                    minHeight: page.style.minHeight,
                    boxShadow: page.style.boxShadow,
                    height: page.style.height,
                    width: page.style.width,
                    margin: page.style.margin
                });

                // Force slightly smaller height to ensure it fits on one PDF page
                // A4 is 297mm. We use 296mm to be safe.
                // We also unset shadow to avoid phantom artifacts
                page.style.minHeight = '296mm';
                page.style.height = '296mm'; // Enforce max height behavior effectively
                page.style.boxShadow = 'none';
                page.style.margin = '0'; // Remove auto margin
                page.style.width = '210mm';
            });

            const opt = {
                margin: 0,
                filename: 'Plano_de_Trabalho.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: {
                    scale: 2,
                    scrollY: 0,
                    useCORS: true
                },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
                pagebreak: { mode: 'css', before: '.page-break-before-class' }
            };

            html2pdf().set(opt).from(element).save().then(() => {
                // Restore original appearance
                element.className = originalClasses;
                pages.forEach((page, i) => {
                    if (originalPageStyles[i]) {
                        page.style.minHeight = originalPageStyles[i].minHeight;
                        page.style.boxShadow = originalPageStyles[i].boxShadow;
                        page.style.height = originalPageStyles[i].height;
                        page.style.width = originalPageStyles[i].width;
                        page.style.margin = originalPageStyles[i].margin;
                    }
                });
            });
        }


    </script>
</body>

</html>